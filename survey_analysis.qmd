---
title: "Pathogen Data Network Survey Analysis"
author: "Your Name"
date: today
format:
  html:
    toc: true
    toc-depth: 3
    code-fold: true
    theme: cosmo
execute:
  warning: false
  message: false
---

## Setup

Load required packages:

```{r}
#| label: setup

library(tidyverse)
library(readxl)
library(janitor)
library(scales)
library(here)
library(rnaturalearth)
library(rnaturalearthdata)
library(sf)
library(cowplot)
```

## Load Data

SurveyMonkey exports have questions in row 1, possible answers (for multiple choice) in row 2, and actual responses starting from row 3.

```{r}
#| message: false
#| label: load-data

# Read the survey data
survey_file <- here("data", "Pathogen Data Network Global Survey of Pathogen Data Stakeholders.xlsx")
question_file <- here("data", "question_data.xlsx")

# Read first two rows to get questions and answer options

questions <- read_excel(question_file)

# questions <- read_excel(survey_file, n_max = 2, col_names = FALSE)

questions_row <- pull(questions, question_short)
answers_row <- pull(questions, plot_answer)

# Read the actual data (starting from row 3)
raw_responses <- read_excel(survey_file, skip = 2, col_names = FALSE) |> as.matrix()
empty_responses <- apply(raw_responses[,11:ncol(raw_responses)], 1, function(x) all(is.na(x)))
raw_responses <- raw_responses[!empty_responses, ]
tf_responses <- !is.na(raw_responses)

for(i in 1:ncol(raw_responses)) {
  raw_responses[tf_responses[,i], i] <- answers_row[i]
}


# Display structure
cat("Number of respondents:", nrow(raw_responses), "\n")
cat("Number of columns:", ncol(raw_responses), "\n")
```

## Data Preparation

Parse the SurveyMonkey structure and create organized data frames:

```{r}
#| label: prepare-data
question_list <- list()
qnum <- 0


for (i in seq_along(questions_row)) {
  if (!is.na(questions_row[i])) {
    qnum <- qnum + 1
    qid <- paste0("q_", sprintf("%03s", qnum))
    # initiate new question
    question_list[[qid]] <- list(
      question = questions_row[i],
      answers =  answers_row[i],
      qstart = i,
      qend = i
    )
  } else {
    question_list[[qid]][["answers"]] <- c(question_list[[qid]][["answers"]], answers_row[i])
    question_list[[qid]][["qend"]] <- i
  }
}

answer_matrix <- matrix(nrow = nrow(raw_responses),
                        ncol = length(question_list))
colnames(answer_matrix) <- names(question_list)

for (qid in names(question_list)) {
  qstart <- question_list[[qid]]$qstart
  qend <- question_list[[qid]]$qend

  if (qstart == qend) {
    
    answer_matrix[, qid] <- raw_responses[, qstart]
  } else {
    answer_matrix[, qid] <- apply(raw_responses[, c(qstart:qend)], 1, function(x) {
      paste(x[!is.na(x)], collapse = ";")
    })
  }
}

answer_matrix[is.na(answer_matrix)] <- ""

unanswered <- apply(answer_matrix, 1, function(x) sum(x == ""))

cat("Repondents leaving 30 questions or more unanswered:", sum(unanswered >= 30), "\n")

answer_matrix <- answer_matrix[unanswered < 30, ]

answer_df <- as.data.frame(answer_matrix)

cat("Number of completed responses:", nrow(answer_matrix), "\n")


```

## Plotting Functions

Helper functions for visualizing multiple choice question results:

```{r}
#| label: plotting-functions

# Function to plot bar chart for multiple choice questions
source("plotting_functions.R")
```

```{r}
#| fig-width: 8
# For questions q_013 through q_029
barrier_questions <- paste0("q_", sprintf("%03d", 13:29))

barrier_questions_plot_combined <- plot_barrier_questions(
  answer_matrix, 
  qid_range = barrier_questions, 
  question_list
)

pdf_filename <- here("output", "combined", "barrier_questions.pdf")
ggsave(pdf_filename, plot = barrier_questions_plot_combined, width = 7, height = 5, device = "pdf")

png_filename <- here("output", "combined", "barrier_questions.png")
ggsave(png_filename, plot = barrier_questions_plot_combined, width = 8, height = 8, device = "png", dpi = 300)

print(barrier_questions_plot_combined)
```


```{r}
mc_questions <- names(question_list)[sapply(question_list,
                                            function(x){
                                              x$qstart != x$qend
                                            })]

# excluding barrier questions and country question (q_033)
mc_questions <- mc_questions[! mc_questions %in% c(barrier_questions, "q_033")]

mc_combined_plot_list <- list()

for(qid in mc_questions){
  # Get answers and count unique values

  n_answers <- length(question_list[[qid]]$answers)
  
  # Calculate dynamic height (minimum 4 inches, add 0.4 inch per answer)
  plot_height <- max(4, n_answers * 0.4 + 2)
  
  # Create plot
  p <- plot_mc_bar(answer_df, qid, question_list)
  
  mc_combined_plot_list[[qid]] <- p
  
  # Save as PDF
  pdf_filename <- here("output", "combined", paste0("barplot_", qid, ".pdf"))
  ggsave(pdf_filename, plot = p, width = 7, height = plot_height, device = "pdf")
  
  # Save as PNG
  png_filename <- here("output", "combined", paste0("barplot_", qid, ".png"))
  ggsave(png_filename, plot = p, width = 7, height = plot_height, device = "png", dpi = 300)
  
  # Also print to document
  print(p)
}
```


```{r}
#| fig-width: 8
#| fig-height: 12

compare_questions <- mc_questions[mc_questions != "q_012"]

mc_comparison_plot_list <- list()

for(qid in compare_questions) {
  
    n_answers <- length(question_list[[qid]]$answers)
  
  # Calculate dynamic height (minimum 4 inches, add 0.4 inch per answer)
  plot_height <- max(4, n_answers * 0.4 + 2)

  
  # Save as PDF

  p <- plot_mc_comparison(
  answer_df, 
  qid = qid,  # The question to compare
  question_list, 
  grouping_qid = "q_012",  # The grouping question
  group1_value = "Analyst, Researcher, or Public healthcare professional",
  group2_value = "Trainer or Educator",
  frequency_cutoff = 1,
  show_percentages = TRUE)  # Use FALSE for counts
  
  mc_comparison_plot_list[[qid]] <- p
  
  pdf_filename <- here("output", "comparison", paste0("barplot_", qid, ".pdf"))
  ggsave(pdf_filename, plot = p, width = 8, height = plot_height, device = "pdf")
  
  png_filename <- here("output", "comparison", paste0("barplot_", qid, ".png"))
  ggsave(png_filename, plot = p, width = 8, height = plot_height, device = "png", dpi = 300)
}

```


```{r}
#| fig-height: 10
p <- plot_barrier_questions(
  answer_df, qid_range = barrier_questions, question_list,
  grouping_qid = "q_012",
  group1_value = "Analyst, Researcher, or Public healthcare professional",
  group2_value = "Trainer or Educator"
)

pdf_filename <- here("output", "comparison", "barrier_questions.pdf")
ggsave(pdf_filename, plot = p, width = 10, height = 8, device = "pdf")

png_filename <- here("output", "comparison", "barrier_questions.png")
ggsave(png_filename, plot = p, width = 10, height = 8, device = "png", dpi = 300)

print(p)
```




## Geographic Distribution

Visualize the geographic distribution of respondents based on their country of work (Question 17):

```{r}
#| label: map-respondents
#| fig-width: 12
#| fig-height: 8

# Count respondents by country (exclude empty responses)
country_counts <- as.data.frame(table(answer_matrix[, "q_033"])) |>
  filter(Var1 != "") |>
  rename(survey_country = Var1, n_respondents = Freq) |>
  mutate(percentage = n_respondents/sum(n_respondents))

# Get world map data
world <- ne_countries(scale = "medium", returnclass = "sf")

# Create mapping between survey country names and map country names
country_mapping <- data.frame(
  survey_country = c(
    "United Kingdom of Great Britain and Northern Ireland"
  ),
  map_country = c(
    "United Kingdom"
  )
)

# Apply mapping to survey data
country_counts <- country_counts |>
  left_join(country_mapping, by = "survey_country") |>
  mutate(country_name = coalesce(map_country, survey_country)) |>
  select(country_name, n_respondents) |>
  mutate(percentage = round(n_respondents/sum(n_respondents)*100, 1)) |>
  arrange(desc(n_respondents))

# Join with world map data
world_data <- world |>
  left_join(country_counts, by = c("name" = "country_name"))

knitr::kable(country_counts)
```

```{r}
# Create the map
world_map_plot <- ggplot(world_data) +
  geom_sf(aes(fill = n_respondents), color = "white", size = 0.2) +
  scale_fill_distiller(
    name = "Number of\nRespondents",
    na.value = "darkgrey",
    palette = "Reds",
    direction = 1,
    trans = "log1p",
    breaks = c(1, 2, 5, 10, 20)
  ) +
  labs(
    # title = "Geographic Distribution of Survey Respondents",
    # subtitle = "Number of respondents by country of work (Question 17)",
    caption = "Grey countries: no respondents"
  ) +
  theme_minimal() +
  theme(
    legend.position = "right",
    plot.title = element_text(size = 16, face = "bold"),
    plot.subtitle = element_text(size = 12),
    axis.text = element_blank(),
    axis.title = element_blank(),
    panel.grid = element_blank()
  )

pdf_filename <- here("output", "combined", "world_map.pdf")
ggsave(pdf_filename, plot = world_map_plot, width = 10, height = 6, device = "pdf")

png_filename <- here("output", "combined", "world_map.png")
ggsave(png_filename, plot = world_map_plot, width = 10, height = 6, device = "png", dpi = 300)

print(world_map_plot)
```

```{r}
#| fig-width: 14
panel_1 <- plot_grid(mc_combined_plot_list[["q_012"]],
                     world_map_plot,
                     mc_combined_plot_list[["q_035"]],
                     mc_combined_plot_list[["q_034"]],
                     labels = LETTERS[1:4])

ggsave(here("output", "panel_1.pdf"), width = 12, height = 8)
print(panel_1)

panel_2 <- plot_grid(barrier_questions_plot_combined,
                    mc_combined_plot_list[["q_030"]],
                    labels = LETTERS[1:2],
                    rel_widths = c(1.1, 0.9))

ggsave(here("output", "panel_2.pdf"), width = 12, height = 8)
print(panel_2)

panel_3 <- plot_grid(mc_combined_plot_list[["q_031"]],
                     mc_comparison_plot_list[["q_031"]],
                     labels = LETTERS[1:2])

ggsave(here("output", "panel_3.pdf"), width = 12, height = 8)
print(panel_3)

panel_4 <- plot_grid(mc_combined_plot_list[["q_032"]],
                     mc_comparison_plot_list[["q_032"]],
                     labels = LETTERS[1:2])

ggsave(here("output", "panel_4.pdf"), width = 12, height = 5)
print(panel_4)

panel_5 <- plot_grid(mc_combined_plot_list[["q_038"]],
                     mc_comparison_plot_list[["q_038"]],
                     labels = LETTERS[1:2])

ggsave(here("output", "panel_5.pdf"), width = 12, height = 9)
print(panel_5)


```

